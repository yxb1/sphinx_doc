# QH01 升级进度管理办法

**一、ECU(ADCC)各阶段百分比分配**

开始升级前：占比**10%**。比如解压zip包、递归查询芯片zip包位置、芯片zip文件分发等。

开始升级-\>刷写结束：占比**90%**。其中各个芯片的固定占比如下。

  ------ ----- ----- ------
  TDA4   J3    MCU   总计
  40%    30%   20%   90%
  ------ ----- ----- ------

**二、ECU(ADCC)百分比计算方式一**

**1.百分比池**

就像彩票中的奖金池概念一样，升级主控程序也要维护一个"百分比池"。不管是全量升级还是差分升级，有可能出现只升级单个或非全部芯片的情况。比如某次升级只升级TDA4和MCU，J3无需更新，那么J3的固定百分比就被纳入"百分比池"。

**2.重分配**

"百分比池"里的额度会被有升级任务的芯片均分，也就是J3的百分比被TDA4和MCU均分（如下所示），以此类推。

  ------ ------------------ ----- ------
  TDA4   J3（无升级任务）   MCU   总计
  55%    0%                 35%   90%
  ------ ------------------ ----- ------

  ------ ----- ------------------- ------
  TDA4   J3    MCU（无升级任务）   总计
  50%    40%   0%                  90%
  ------ ----- ------------------- ------

  -------------------- ----- ----- ------
  TDA4（无升级任务）   J3    MCU   总计
  0%                   50%   40%   90%
  -------------------- ----- ----- ------

**3.计算方式举例**

ECU当前整体升级进度的具体计算办法如下（假定当前经过重分配后的芯片百分比如下表所示）

  ------ ------------------ ----- ------
  TDA4   J3（无升级任务）   MCU   总计
  55%    0%                 35%   90%
  ------ ------------------ ----- ------

TDA4当前升级进度50%，MCU当前升级进度100%。

ECU百分比 = （55%\*50 + 35%\*100）+10%（开始升级前的固定百分比）

得到ECU百分比 = 72.5%

**三、ECU(ADCC)百分比计算方式二**

**1.分子分母**

ecu总百分比 =
（0.4\*x\*a+0.3\*y\*b+0.2\*z\*c）/（0.4\*a+0.3\*b+0.2\*c）\*0.9

x y z为对应芯片自身的实际升级进度，取值0-100%；

a b c 表示对应芯片是否有升级任务，有任务是1，没有任务是0；

**2.计算方式举例**

**2.1所有芯片都有刷写任务**

tda4 = （0.4~~+0.3+0.2~~）/（0.4+0.3+0.2）\*0.9 = 0.4

**2.1mcu无刷写任务**

tda4 = （0.4~~+0.3+0.2~~）/（0.4+0.3~~+0.2~~）\*0.9 = 0.51

j3 = （~~0.4+~~0.3~~+0.2~~）/（0.4+0.3~~+0.2~~）\*0.9 = 0.38

Mcu = （~~0.4+0.3+0.2~~）/（0.4+0.3~~+0.2~~）\*0.9 = 0.00

大体意思就是如果某芯片没有刷写任务，在分母分子中就删除其份额值，比如mcu无升级任务：

ecu总百分比 = （0.4+0.3~~+0.2~~）/（0.4+0.3~~+0.2~~）\*0.9

其它芯片在计算时，忽略mcu的百分比，只需计算tda4和j3重新分配后的份额值即可，具体如上。

**四、芯片内部升级进度计算方式**

对于芯片内部而言，**升级进度就是[0-100]{.underline}**，不用care主控程序的百分比计算方式，只需关心内部的升级进度即可。

芯片内部没有"百分比池"的概念，其百分比计算方式有两种思路，一种是按照文件大小，一种是按照文件数量。

**1.方案一：文件大小百分比计算方式**

以TDA4为例，在一次升级中，各全量/差分文件大小如下：

  ------ ----- ------ -------- ------ ----- ----- ----------
  分区   app   boot   system   data   map   ota   总计大小
  大小   10K   2k     8k       6k     10k   10k   46k
  ------ ----- ------ -------- ------ ----- ----- ----------

简单的按照升级文件占总计大小的比例计算的结果如下（只保留两位数）：

  ------ ----- ------ -------- ------ ----- ----- ----------
  分区   app   boot   system   data   map   ota   总计进度
  大小   21    4      16       13     21    21    96
  ------ ----- ------ -------- ------ ----- ----- ----------

计算结果很明显总计百分比不满足100%的需求，此时需要把差值随意添加到某一文件上去即可，比如：

  ------ ----- --------- -------- ------ ----- ----- ----------
  分区   app   boot      system   data   map   ota   总计进度
  大小   21    4**+4**   16       13     21    21    100
  ------ ----- --------- -------- ------ ----- ----- ----------

**2.方案二：文件数量百分比计算方式**

以TDA4为例，在一次升级中，各全量/差分文件如下：

  --------- ---------- ------------ ---------- --------- --------- ----------
  app       boot       system       data       map       ota       总计数量
  app.img   boot.img   system.img   data.img   map.img   ota.img   6个
  --------- ---------- ------------ ---------- --------- --------- ----------

按照均分百分比的思路，计算如下（只保留两位数）：

  ----- ------ -------- ------ ----- ----- ----------
  app   boot   system   data   map   ota   总计进度
  16    16     16       16     16    16    96
  ----- ------ -------- ------ ----- ----- ----------

计算结果很明显总计百分比不满足100%的需求，此时需要把差值随意添加到某一文件上去即可，比如：

  ---------- ------ -------- ------ ----- ----- ----------
  app        boot   system   data   map   ota   总计进度
  16**+4**   16     16       16     16    16    100
  ---------- ------ -------- ------ ----- ----- ----------
  
